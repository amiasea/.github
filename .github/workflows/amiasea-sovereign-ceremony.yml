name: "Amiasea: Sovereign Bootstrap (First Manifestation)"

on:
  workflow_dispatch:
    inputs:
      tenant_id: { required: true }
      subscription_id: { required: true }
      client_id: { required: true } # The Provisioner UAMI Client ID
      github_wip: { required: true } # HCP Workload Identity Provider path
      private_key_pem: { required: true }
      resource_group_name:
        required: true
        default: "rg-amiasea"
      location:
        required: true
        default: "centralus"

permissions:
  id-token: write # Required for both Azure and HCP OIDC handshakes
  contents: read

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # --- IDENTITY PHASE: OIDC Handshakes ---
      
      - name: Authenticate to HCP (OIDC)
        id: hcp_auth
        uses: hashicorp/hcp-auth-action@v0.1.0
        with:
          workload_identity_provider: ${{ github.event.inputs.github_wip }}
          set_access_token: true # Required to generate the output for the TFE provider

      - name: Authenticate to Azure (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ github.event.inputs.client_id }}
          tenant-id: ${{ github.event.inputs.tenant_id }}
          subscription-id: ${{ github.event.inputs.subscription_id }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.6"
          terraform_wrapper: false
          cli_config_credentials_token: ${{ steps.hcp_auth.outputs.access_token }}

      # --- EXECUTION PHASE ---

      - name: Orchestration
        working-directory: ./terraform/orchestration
        # env:
        #   # Only this step consumes the HCP token for the TFE provider
        #   TFE_TOKEN: ${{ steps.hcp_auth.outputs.access_token }}
        run: |
          terraform init
          terraform apply -auto-approve

      # - name: Authority
      #   id: auth_tf
      #   working-directory: ./terraform/authority
      #   env:
      #     ARM_USE_OIDC: "true"
      #   run: |
      #     terraform init
      #     terraform apply -auto-approve \
      #       -var="resource_group_name=${{ github.event.inputs.resource_group_name }}" \
      #       -var="location=${{ github.event.inputs.location }}" \
      #       -var="tenant_id=${{ github.event.inputs.tenant_id }}"
      #     # Capture outputs for the next step in the same runner session
      #     echo "uami_client_id=$(terraform output -raw uami_client_id)" >> $GITHUB_ENV
      #     echo "uami_principal_id=$(terraform output -raw uami_principal_id)" >> $GITHUB_ENV

      # - name: Identity
      #   working-directory: ./terraform/identity
      #   env:
      #     ARM_USE_OIDC: "true"
      #   run: |
      #     terraform init
      #     terraform apply -auto-approve \
      #       -var="tenant_id=${{ github.event.inputs.tenant_id }}" \
      #       -var="client_id=${{ env.uami_client_id }}" \
      #       -var="principal_object_id=${{ env.uami_principal_id }}"

      # - name: Import Private Key to Vault
      #   run: |
      #     echo "${{ github.event.inputs.private_key_pem }}" > private_key.pem
      #     # Uses the existing 'azure/login' session
      #     az keyvault key import \
      #       --vault-name "kv-amiasea" \
      #       --name "amiasea-github-private-key" \
      #       --pem-file private_key.pem
      #     rm private_key.pem

name: "Amiasea: Sovereign Bootstrap (First Manifestation)"

on:
  workflow_dispatch:
    inputs:
      subscription_id:
        required: true
      access_token:
        required: true
      private_key_pem:
        required: true
      hcp_client_id:
        required: true
      hcp_pat:
        required: true
      resource_group_name:
        required: true
      location:
        required: true
      dockerhub_username:
        required: true
      dockerhub_password:
        required: true
      tenant_id:
        required: true

jobs:
  bootstrap:
    runs-on: ubuntu-latest

    env:
      ARM_ACCESS_TOKEN: ${{ github.event.inputs.access_token }}
      ARM_SUBSCRIPTION_ID: ${{ github.event.inputs.subscription_id }}
      ARM_TENANT_ID: ${{ github.event.inputs.tenant_id }}

      HCP_CLIENT_ID: ${{ github.event.inputs.hcp_client_id }}
      HCP_CLIENT_SECRET: ${{ github.event.inputs.hcp_pat }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.6" # Specify your required version
          terraform_wrapper: false   # Recommended for complex 'run' scripts

      # 1. PLATFORM
      - name: platform
        working-directory: ./terraform/platform
        run: |
          terraform init
          terraform apply -auto-approve
          terraform output -json > ../platform.json

      # 2. ORCHESTRATION
      - name: orchestration
        working-directory: ./terraform/orchestration
        run: |
          terraform init
          terraform apply -auto-approve \
            -var="tfe_project_id=$(jq -r '.amiasea_project_id.value' ../platform.json)" \
            -var="resource_group_name=${{ github.event.inputs.resource_group_name }}" \
            -var="location=${{ github.event.inputs.location }}" \
            -var="dockerhub_username=${{ github.event.inputs.dockerhub_username }}" \
            -var="dockerhub_password=${{ github.event.inputs.dockerhub_password }}" \
            -var="tenant_id=${{ github.event.inputs.tenant_id }}"
          terraform output -json > ../orchestration.json

      # 3. AUTHORITY
      - name: authority
        working-directory: ./terraform/authority
        run: |
          terraform init
          terraform apply -auto-approve \
            -var="resource_group_name=${{ github.event.inputs.resource_group_name }}" \
            -var="location=${{ github.event.inputs.location }}" \
            -var="dockerhub_username=${{ github.event.inputs.dockerhub_username }}" \
            -var="dockerhub_password=${{ github.event.inputs.dockerhub_password }}" \
            -var="tenant_id=${{ github.event.inputs.tenant_id }}"
          terraform output -json > ../authority.json

      # 4. IDENTITY
      - name: identity
        working-directory: ./terraform/identity
        run: |
          terraform init
          terraform apply -auto-approve \
            -var="tenant_id=${{ github.event.inputs.tenant_id }}" \
            -var="client_id=$(jq -r '.uami_client_id.value' ../authority.json)" \
            -var="principal_object_id=$(jq -r '.uami_principal_id.value' ../authority.json)"

      # Key Vault import
      - name: import private key
        run: |
          echo "${{ github.event.inputs.private_key_pem }}" > private_key.pem
          az keyvault key import \
            --vault-name "kv-amiasea" \
            --name "amiasea-github-private-key" \
            --pem-file private_key.pem \
            --ops sign \
            --subscription ${{ github.event.inputs.subscription_id }} \
            --access-token "${{ github.event.inputs.access_token }}"
          rm private_key.pem